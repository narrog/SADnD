@page "/character-details/{id}"
@attribute [Authorize]
@inject CharacterSyncManager characterManager
@inject IJSRuntime js

<CascadingValue Value="@this" IsFixed="true">
    @if (Character != null) {
        <h3>"@Character.Name"</h3>

        <div class="container-fluid mt-3">
            <div class="row">
                <div class="col-12 col-md-4">
                    <p><strong>Rasse: </strong>@(Character.Race != null ? Character.Race.Name : "Unbekannt")</p>
                    @if (Character.Classes != null && Character.Classes.Any()) {
                        <p>
                            <strong>Klassen</strong>
                            <ul>
                                @foreach (var characterClass in Character.Classes) {
                                    @if (characterClass.Class != null) {
                                        <li>
                                            @characterClass.Class.Name, Level: @characterClass.Level
                                        </li>
                                    }
                                }
                            </ul>
                        </p>
                    }
                    else {
                        <p>Keine Klasse zugeordnet</p>
                    }
                    @* TODO:
                    <p><strong>Trefferpunkte: </strong>@Character.Hitpoints </p>
                    <p><strong>Spellslots: </strong></p> *@
                    <button class="btn btn-outline-secondary mt-md-5" @onclick="ShowCharacterDetails">
                        <span class="oi oi-eye me-2"></span> @showDetailsText
                    </button>
                    <a class="btn btn-outline-primary mt-md-5" href="/new-character/@Id">
                        <span class="oi oi-pencil me-2"></span> bearbeiten
                    </a>

                </div>
                @if (showCharacterDetails) {
                    <div class="col-12 col-md-4 mt-3 mt-md-0">
                        <p>
                            <strong>Grösse-Kategorie: </strong>@(Character.SizeCategory != null ? Character.SizeCategory : "Unbekannt")<br />
                            <strong>Grösse: </strong>@(Character.Size != null ? Character.Size : "Unbekannt")<br />
                            <strong>Geschlecht: </strong>@(Character.Sex != null ? Character.Sex : "Unbekannt")<br />
                            <strong>Gesinnung: </strong>@(Character.Alignment != null ? Character.Alignment : "Unbekannt")<br />
                            <strong>Alter: </strong>@(Character.Age != null ? Character.Age : "Unbekannt")<br />
                            <strong>Gewicht: </strong>@(Character.Weight != null ? Character.Weight : "Unbekannt")
                        </p>
                    </div>
                }
            </div>

            <div class="row mt-3">
                <div class="col-2 my-1" id="notes-icons-container">
                    <CharacterNotesIcons @bind-ActiveCategory="activeCategory"
                                         CharacterId="@Character.Id"
                                         OnCategoryChanged="HandleCategoryChanged" />
                </div>

                <div class="col-10 my-2">
                    @if(activeCategory == "inventory") {
                        @if (!showAddItems) {
                            <InventoryView Character="@Character"
                                           UnitOfWeight="@unitOfWeight" />
                            <button class="btn btn-secondary mt-1" @onclick="ShowAddItems">Item hinzufügen</button>
                        }
                        else {
                            <InventoryItemAdd OnClose="HideAddItems"
                                              UnitOfWeight="@unitOfWeight" />
                        }
                        
                    }
                    else {
                        @if (!showAddNotes) {
                            <NotesView NotesCategory="@activeCategory"
                                       CharacterId="@Character.Id"
                                       @ref="notesViewReference" />
                            <button class="btn btn-secondary mt-1" @onclick="() => ShowAddNotes(0)">Notiz hinzufügen</button>
                        }
                        else {
                            <NotesAdd NotesCategory="@activeCategory"
                                      SelectedNoteId="@selectedNoteId"
                                      CharacterId="@Character.Id"
                                      OnClose="HideAddNotes" />
                        }
                        
                    }
                </div>
            </div>
        </div>
        <div class="container-fluid mt-3">
            <a class="btn btn-outline-primary me-2" onclick="history.back();">Zurück</a>
            <button class="btn btn-outline-danger" @onclick="DeleteCharacter">Löschen</button>
        </div>
    }
</CascadingValue>



@code {
    [CascadingParameter]
    public CascadingAppState appState { get; set; }
    [Parameter] 
    public required string Id { get; set; }
    public Character Character = new Character();

    private bool showCharacterDetails;
    private string showDetailsText = "Details anzeigen";
    public string activeCategory = "inventory";
    private NotesView? notesViewReference;

    private bool showAddItems;
    private string unitOfWeight = "kg";

    private bool showAddNotes;
    private int selectedNoteId;

    protected override async Task OnInitializedAsync() {
        Character = await characterManager.GetByID(Id);
        await appState.GetNotes();
    }

    private async Task DeleteCharacter() {
        string toDeleteName = Character.Name;
        bool confirm = await js.InvokeAsync<bool>("confirm", $"Soll der Eintrag '{toDeleteName}' wirklich gelöscht werden?\r\nAlle Notizen werden ebenfalls gelöscht.\r\nDas Löschen kann nicht Rückgängig gemacht werden");
        if (!confirm) return;

        await characterManager.Delete(Character.Id);
        await js.InvokeVoidAsync("history.back");
    }

    private void ShowCharacterDetails() {
        showCharacterDetails = !showCharacterDetails;
        showDetailsText = showCharacterDetails ? "Details ausblenden" : "Details anzeigen";
        StateHasChanged();
    }


    private void HandleCategoryChanged() {
        if (notesViewReference != null) {
            notesViewReference.ResetAddNotes();
        }
    }

    private async void ShowAddItems() {
        showAddItems = true;
        Character = await characterManager.GetByID(Character.Id);
        StateHasChanged();
    }
    private async void HideAddItems() {
        Character = await characterManager.GetByID(Character.Id);
        showAddItems = false;
        StateHasChanged();
        // GetWeightSum();
    }

    private async void ShowAddNotes(int noteId) {
        selectedNoteId = noteId;
        showAddNotes = true;
        await OnParametersSetAsync();
        StateHasChanged();
    }
    private async void HideAddNotes() {
        await OnParametersSetAsync();
        showAddNotes = false;
        StateHasChanged();
    }
    public void ResetAddNotes() {
        showAddNotes = false;
        StateHasChanged();
    }
}
