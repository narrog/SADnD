@inject CharacterManager characterManager

<div class="col-10 col-md-6 my-2">
    <h4>Inventar</h4>
    <table class="table table-striped">
        <tbody>
            @if (Character.Inventory != null && Character.Inventory.Any() != false) {
                @foreach (var inventoryItem in Character.Inventory) {
                    <tr>
                        <td width="8%" class="align-middle">
                            @inventoryItem.Count
                        </td>
                        <td width="12%" class="align-middle">
                            <button @onclick="() => IncreaseItemCount(inventoryItem)" title="Anzahl erhöhen">+</button>
                            <button @onclick="() => DecreaseItemCount(inventoryItem)" title="Anzahl verringern">-</button>
                        </td>
                        @if (inventoryItem.Item != null) {
                            <td width="50%" class="align-middle">@inventoryItem.Item.Name</td>
                            @if (inventoryItem.Item.Weight != null) {
                                <td width="15%" class="align-middle text-end">
                                    @inventoryItem.Item.Weight @unitOfWeight
                                </td>
                                <td width="15%" class="align-middle text-end">
                                    @(inventoryItem.Count * inventoryItem.Item.Weight) @unitOfWeight
                                </td>
                            }
                            else {
                                <td width="15%"></td>
                                <td width="15%"></td>
                            }
                        }
                    </tr>
                }
                <tr>
                    <td class="align-middle text-end" colspan="4">Gewicht Total</td>
                    <td class="align-middle text-end">@weightTotal @unitOfWeight</td>
                </tr>
            }
            else {
                <tr><td>Keine Items gefunden</td></tr>
            }
        </tbody>
    </table>
    @if (showUIMessage) {
        <ul class="mt-3">
            <li class="validation-message">
                @UIMessage
            </li>
        </ul>
    }
</div>
<div class="col-12 col-md-4">
    @if (!showAddItems) {
        <button class="btn btn-secondary" @onclick="ShowAddItems">Item hinzufügen</button>
    }
    else {
        <InventoryItemAdd OnClose="HideAddItems"
                          UnitOfWeight="@unitOfWeight" />
    }
</div>

@code {
    [Parameter]
    public required Character Character { get; set; }

    private bool showAddItems;
    private bool showUIMessage;
    private string UIMessage = string.Empty;
    private string unitOfWeight = "kg";
    private float weightTotal;

    protected override async Task OnInitializedAsync() {
        GetWeightSum();
    }

    private async void ShowAddItems() {
        UIMessage = "";
        showAddItems = true;
        Character = await characterManager.GetByID(Character.Id);
        StateHasChanged();
    }
    private async void HideAddItems() {
        Character = await characterManager.GetByID(Character.Id);
        showAddItems = false;
        StateHasChanged();
        GetWeightSum();
    }

    private void GetWeightSum() {
        weightTotal = 0;
        float weightProduct;
        if (Character.Inventory != null && Character.Inventory.Any()) {
            foreach (var inventoryItem in Character.Inventory) {
                @if (inventoryItem.Item != null) {
                    @if (inventoryItem.Item.Weight != null) {
                        weightProduct = inventoryItem.Item.Weight.Value * inventoryItem.Count;
                        weightTotal += weightProduct;
                    }
                }
            }
        }
    }

    private async Task IncreaseItemCount(Inventory inventoryItem) {
        showUIMessage = false;
        inventoryItem.Count++;
        await UpdateItemCount();
    }
    private async Task DecreaseItemCount(Inventory inventoryItem) {
        showUIMessage = false;
        if (inventoryItem.Count == 1) {

            await DeleteItemFromInventory(inventoryItem);
            return;
        }

        inventoryItem.Count--;
        await UpdateItemCount();
    }
    private async Task UpdateItemCount() {
        await characterManager.Update(Character);
        GetWeightSum();
        StateHasChanged();
    }

    private async Task DeleteItemFromInventory(Inventory inventoryItem) {
        try {
            if (Character.Inventory != null && Character.Inventory.Any()) {
                var itemToRemove = Character.Inventory.FirstOrDefault(i => i.Item.Id == inventoryItem.Item.Id);

                if (itemToRemove != null) {

                    string itemName = itemToRemove.Item!.Name;
                    Character.Inventory!.Remove(itemToRemove);
                    UIMessage = $"Item '{itemName}' wurde aus dem Inventar entfernt";
                    showUIMessage = true;
                }
            }
            Character = await characterManager.Update(Character);

        }
        catch (Exception ex) {
            Console.WriteLine($"{ex.Message}");
        }

    }
}
