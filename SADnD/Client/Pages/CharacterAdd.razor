@page "/new-character"

@attribute [Authorize]
@using Newtonsoft.Json
@inject IJSRuntime js

@inject CharacterManager characterManager
@inject ClassManager classManager
@inject RaceManager raceManager

<h3>Charakter hinzufügen</h3>

@if (races != null && AvailableClasses != null) {
    <div class="container-fluid mt-3">
        <div class="row">
            <EditForm Model="@character" OnValidSubmit="@Post">
                <DataAnnotationsValidator />
                <div class="col-12 col-md-8 p-1">
                    Name: <InputText @bind-Value="@character.Name"></InputText>
                </div>
                <div class="col-12 col-md-4 p-1">
                    Rasse: 
                    <InputSelect @bind-Value="@character.RaceId">
                        <option selected value="0">Bitte auswählen</option>
                        @foreach (var race in races) {
                            <option value="@race.Id">@race.Name</option>
                        }
                    </InputSelect>
                </div>
                <div class="col-12 col-md-4 p-1">
                    Klasse:
                    @* @foreach (var classItem in AvailableClasses) {
                        <div>
                            <input type="checkbox" @onchange="(e => UpdateSelection(classItem.Id, (bool)e.Value))" />
                            <label>@classItem.Name</label>
                        </div>
                    } *@
                    @foreach (var charClass in character.Classes)
                    {
                        <InputSelect @bind-Value="@charClass.ClassId">
                            <option selected value="">Bitte auswählen</option>
                            @foreach (var characterClass in AvailableClasses)
                            {
                                <option value="@characterClass.Id">@characterClass.Name</option>
                            }
                        </InputSelect>
                        <InputNumber @bind-Value="@charClass.Level">
                        </InputNumber>
                        <button onclick="@AddClass">+</button>
                    }
                    
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary me-2">Speichern</button>
                    <button class="btn btn-secondary" type="button" @onclick="CancelButtonPressed">Abbrechen</button>
                </div>
                <ValidationSummary class="mt-3" />
            </EditForm>
        </div>
    </div>
}
<div class="mt-3">
    @UIMessage
</div>

@code {
    private Character character = new Character() { 
        Classes = new List<CharacterClass>() { 
            new CharacterClass() { Level = 1 } 
        } 
    };
    private IEnumerable<Class> AvailableClasses;
    private IEnumerable<Race> races;
    string UIMessage = "";
    string controllerName = "character";
    string message = "";
    string name = "";

    protected override async Task OnInitializedAsync() {
        AvailableClasses = await classManager.GetAll();
        races = await raceManager.GetAll();

        foreach (var classItem in AvailableClasses) {
            SelectedClassIds[classItem.Id] = false; // Standardwert ist false (nicht ausgewählt)
        }
    }

    private async void Post() {

        try {
            var selectedClasses = AvailableClasses
            .Where(c => SelectedClassIds.ContainsKey(c.Id) && SelectedClassIds[c.Id])
            .ToList();

            // Hier aktualisieren Sie Ihr Modell
            // character.Classes = selectedClasses;
            // foreach (var x in character.Classes) {
            //     Console.WriteLine($"gewählte Klasse: {x.Id} - {x.Name}");
            // }

            message = JsonConvert.SerializeObject(await characterManager.Insert(character));
            Console.WriteLine($"message: {message}");

            //await js.InvokeVoidAsync("history.back");
        }
        catch (Exception ex) {
            UIMessage = ex.Message;
            Console.WriteLine($"{ex.Message}");
            StateHasChanged();
        }
    }
    private async void CancelButtonPressed() {
        bool confirm = await js.InvokeAsync<bool>("confirm", "Eingabe wirklich abbrechen");
        if (confirm)
            await js.InvokeVoidAsync("history.back");
        else
            return;
    }

    private void AddClass()
    {
        character.Classes.Add(new CharacterClass(){
            CharacterId = character.Id, 
            Level = 1
        });
    }

    // Die ausgewählten Klassen-IDs
    private Dictionary<int, bool> SelectedClassIds = new();

    // Methode zum Aktualisieren der Auswahl
    private void UpdateSelection(int classId, bool isSelected) {
        SelectedClassIds[classId] = isSelected;
    }
}
